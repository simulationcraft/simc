action_priority_list_t* precombat = get_action_priority_list( "precombat" );
action_priority_list_t* def = get_action_priority_list( "default" );
action_priority_list_t* variables = get_action_priority_list( "variables" );
action_priority_list_t* clearcasting = get_action_priority_list( "clearcasting" );
action_priority_list_t* builder = get_action_priority_list( "builder" );
action_priority_list_t* aoe_builder = get_action_priority_list( "aoe_builder" );
action_priority_list_t* bloodtalons = get_action_priority_list( "bloodtalons" );
action_priority_list_t* berserk = get_action_priority_list( "berserk" );
action_priority_list_t* finisher = get_action_priority_list( "finisher" );
action_priority_list_t* cooldown = get_action_priority_list( "cooldown" );

precombat->add_action( "cat_form,if=!buff.cat_form.up","Snapshot raid buffed stats before combat begins and pre-potting is done." );
precombat->add_action( "heart_of_the_wild" );
precombat->add_action( "use_item,name=algethar_puzzle_box" );
precombat->add_action( "prowl,if=!buff.prowl.up" );

def->add_action( "prowl,if=buff.bs_inc.down&!buff.prowl.up" );
def->add_action( "cat_form,if=!buff.cat_form.up" );
def->add_action( "invoke_external_buff,name=power_infusion,if=buff.bs_inc.up|fight_remains<cooldown.bs_inc.remains" );
def->add_action( "call_action_list,name=variables" );
def->add_action( "tigers_fury,if=!talent.convoke_the_spirits.enabled&(!buff.tigers_fury.up|energy.deficit>65)" );
def->add_action( "tigers_fury,if=talent.convoke_the_spirits.enabled&(!variable.lastConvoke|(variable.lastConvoke&!buff.tigers_fury.up))" );
def->add_action( "rake,if=buff.prowl.up|buff.shadowmeld.up" );
def->add_action( "auto_attack,if=!buff.prowl.up&!buff.shadowmeld.up" );
def->add_action( "adaptive_swarm,target_if=((!dot.adaptive_swarm_damage.ticking|dot.adaptive_swarm_damage.remains<2)&(dot.adaptive_swarm_damage.stack<3|!dot.adaptive_swarm_heal.stack>1)&!action.adaptive_swarm_heal.in_flight&!action.adaptive_swarm_damage.in_flight&!action.adaptive_swarm.in_flight)&target.time_to_die>5|active_enemies>2&!dot.adaptive_swarm_damage.ticking&energy<35&target.time_to_die>5" );
def->add_action( "call_action_list,name=cooldown" );
def->add_action( "feral_frenzy,target_if=max:target.time_to_die,if=combo_points<2|combo_points<3&buff.bs_inc.up" );
def->add_action( "ferocious_bite,target_if=max:target.time_to_die,if=buff.apex_predators_craving.up&(spell_targets.swipe_cat=1|!talent.primal_wrath.enabled|!buff.sabertooth.up)" );
def->add_action( "call_action_list,name=berserk,if=buff.bs_inc.up" );
def->add_action( "call_action_list,name=finisher,if=combo_points>=4&spell_targets.swipe_cat>1" );
def->add_action( "wait,sec=combo_points=5,if=combo_points=4&buff.predator_revealed.react&energy.deficit>40" );
def->add_action( "call_action_list,name=finisher,if=combo_points>=4" );
def->add_action( "call_action_list,name=bloodtalons,if=variable.need_bt&!buff.bs_inc.up&combo_points<5" );
def->add_action( "run_action_list,name=aoe_builder,if=spell_targets.swipe_cat>1&talent.primal_wrath.enabled" );
def->add_action( "call_action_list,name=builder,if=combo_points<5&!buff.bs_inc.up" );

variables->add_action( "variable,name=need_bt,value=talent.bloodtalons.enabled&buff.bloodtalons.stack<2" );
variables->add_action( "variable,name=align_3minutes,value=spell_targets.swipe_cat=1&!fight_style.dungeonslice" );
variables->add_action( "variable,name=lastConvoke,value=fight_remains>cooldown.convoke_the_spirits.remains+3&((talent.ashamanes_guidance.enabled&fight_remains<(cooldown.convoke_the_spirits.remains+60))|(!talent.ashamanes_guidance.enabled&fight_remains<(cooldown.convoke_the_spirits.remains+120)))" );
variables->add_action( "variable,name=lastZerk,value=fight_remains>(30+(cooldown.bs_inc.remains%1.6))&((talent.berserk_heart_of_the_lion.enabled&fight_remains<(90+(cooldown.bs_inc.remains%1.6)))|(!talent.berserk_heart_of_the_lion.enabled&fight_remains<(180+cooldown.bs_inc.remains)))" );
variables->add_action( "variable,name=zerk_biteweave,op=reset" );

clearcasting->add_action( "thrash_cat,if=refreshable&!talent.thrashing_claws.enabled" );
clearcasting->add_action( "swipe_cat,if=spell_targets.swipe_cat>1" );
clearcasting->add_action( "brutal_slash,if=spell_targets.brutal_slash>2" );
clearcasting->add_action( "shred" );

builder->add_action( "run_action_list,name=clearcasting,if=buff.clearcasting.react" );
builder->add_action( "brutal_slash,if=cooldown.brutal_slash.full_recharge_time<4" );
builder->add_action( "pool_resource,if=!action.rake.ready&(dot.rake.refreshable|(buff.sudden_ambush.up&persistent_multiplier>dot.rake.pmultiplier&dot.rake.remains>6))&!buff.clearcasting.react","stop pooling if we can use a clearcasting proc" );
builder->add_action( "rake,target_if=max:ticks_gained_on_refresh,if=refreshable|(buff.sudden_ambush.up&persistent_multiplier>dot.rake.pmultiplier&dot.rake.remains>6)","this isn't perfect, as it only checks the target with lowest remaining dot. Feel free to improve" );
builder->add_action( "run_action_list,name=clearcasting,if=buff.clearcasting.react","repeating here is necessary, otherwise moonfire will occassionally be casted instead" );
builder->add_action( "moonfire_cat,target_if=refreshable" );
builder->add_action( "thrash_cat,target_if=refreshable&!talent.thrashing_claws.enabled" );
builder->add_action( "brutal_slash" );
builder->add_action( "swipe_cat,if=spell_targets.swipe_cat>1" );
builder->add_action( "shred" );

aoe_builder->add_action( "brutal_slash,if=cooldown.brutal_slash.full_recharge_time<4","never let brutal slash cap charges" );
aoe_builder->add_action( "rake,target_if=max:druid.rake.ticks_gained_on_refresh,if=(refreshable|1.4*persistent_multiplier>dot.rake.pmultiplier)&buff.bt_rake.down" );
aoe_builder->add_action( "thrash_cat,target_if=refreshable,if=!talent.thrashing_claws.enabled" );
aoe_builder->add_action( "brutal_slash" );
aoe_builder->add_action( "rake,target_if=max:druid.rake.ticks_gained_on_refresh,if=(refreshable|1.4*persistent_multiplier>dot.rake.pmultiplier)" );
aoe_builder->add_action( "moonfire_cat,target_if=max:((ticks_gained_on_refresh+1)-(spell_targets.swipe_cat*2.492))","Full Lis beat Swipe up til around 3-ish targets depending on haste  --this needs looked at" );
aoe_builder->add_action( "swipe_cat" );
aoe_builder->add_action( "shred,target_if=max:target.time_to_die,if=action.shred.damage>action.thrash_cat.damage","If we have BrS and nothing better to cast, check if Thrash DD beats Shred" );
aoe_builder->add_action( "thrash_cat" );

bloodtalons->add_action( "rake,target_if=max:druid.rake.ticks_gained_on_refresh,if=(refreshable|1.4*persistent_multiplier>dot.rake.pmultiplier)&buff.bt_rake.down" );
bloodtalons->add_action( "shred,if=buff.bt_shred.down&buff.clearcasting.react&spell_targets.swipe_cat=1" );
bloodtalons->add_action( "thrash_cat,target_if=refreshable,if=buff.bt_thrash.down&buff.clearcasting.react&spell_targets.swipe_cat=1&!talent.thrashing_claws.enabled" );
bloodtalons->add_action( "brutal_slash,if=buff.bt_brutal_slash.down" );
bloodtalons->add_action( "moonfire_cat,if=refreshable&buff.bt_moonfire.down&spell_targets.swipe_cat=1" );
bloodtalons->add_action( "thrash_cat,target_if=refreshable,if=buff.bt_thrash.down&!talent.thrashing_claws.enabled" );
bloodtalons->add_action( "shred,if=buff.bt_shred.down&spell_targets.swipe_cat=1" );
bloodtalons->add_action( "moonfire_cat,target_if=max:((ticks_gained_on_refresh+1)-(spell_targets.swipe_cat*2.492)),if=buff.bt_moonfire.down" );
bloodtalons->add_action( "swipe_cat,if=buff.bt_swipe.down" );
bloodtalons->add_action( "moonfire_cat,target_if=max:target.time_to_die,if=buff.bt_moonfire.down" );
bloodtalons->add_action( "shred,target_if=max:target.time_to_die,if=action.shred.damage>action.thrash_cat.damage&buff.bt_shred.down","If we have BrS and nothing better to cast, check if shred beats thrash DD" );
bloodtalons->add_action( "thrash_cat,if=buff.bt_thrash.down" );

berserk->add_action( "ferocious_bite,target_if=max:target.time_to_die,if=combo_points=5&dot.rip.remains>8&variable.zerk_biteweave&spell_targets.swipe_cat>1" );
berserk->add_action( "call_action_list,name=finisher,if=combo_points=5" );
berserk->add_action( "call_action_list,name=bloodtalons,if=combo_points<5&spell_targets.swipe_cat>1","its currently a gain to just contiuously try to proc bt in aoe" );
berserk->add_action( "rake,if=refreshable|(buff.sudden_ambush.up&persistent_multiplier>dot.rake.pmultiplier&!dot.rake.refreshable)" );
berserk->add_action( "shred,if=active_bt_triggers=2&buff.bt_shred.down","in single target, you just proc bt when an opportunity arises" );
berserk->add_action( "brutal_slash,if=active_bt_triggers=2&buff.bt_brutal_slash.down" );
berserk->add_action( "moonfire_cat,if=active_bt_triggers=2&buff.bt_moonfire.down" );
berserk->add_action( "thrash_cat,if=active_bt_triggers=2&buff.bt_thrash.down&!talent.thrashing_claws" );
berserk->add_action( "brutal_slash,if=cooldown.brutal_slash.charges>1","don't overcap brs charges, but keep it available for bt" );
berserk->add_action( "shred" );

finisher->add_action( "primal_wrath,if=((dot.primal_wrath.refreshable&!talent.circle_of_life_and_death.enabled)|dot.primal_wrath.remains<6|talent.tear_open_wounds.enabled)&spell_targets.primal_wrath>1&talent.primal_wrath.enabled" );
finisher->add_action( "rip,target_if=refreshable" );
finisher->add_action( "pool_resource,for_next=1,if=!action.tigers_fury.ready&buff.apex_predators_craving.down" );
finisher->add_action( "ferocious_bite,max_energy=1,target_if=max:target.time_to_die,if=buff.apex_predators_craving.down&(!buff.bs_inc.up|(buff.bs_inc.up&!talent.soul_of_the_forest.enabled))" );
finisher->add_action( "ferocious_bite,target_if=max:target.time_to_die,if=(buff.bs_inc.up&talent.soul_of_the_forest.enabled)|buff.apex_predators_craving.up" );

cooldown->add_action( "use_item,name=algethar_puzzle_box,if=fight_remains<35|(!variable.align_3minutes)" );
cooldown->add_action( "use_item,name=algethar_puzzle_box,if=variable.align_3minutes&(cooldown.bs_inc.remains<3&(!variable.lastZerk|!variable.lastConvoke|(variable.lastConvoke&cooldown.convoke_the_spirits.remains<13)))" );
cooldown->add_action( "incarnation" );
cooldown->add_action( "berserk,if=(!variable.lastZerk)|(fight_remains<23)|(variable.lastZerk&!variable.lastConvoke)" );
cooldown->add_action( "berserk,if=(variable.lastConvoke&cooldown.convoke_the_spirits.remains<10)" );
cooldown->add_action( "berserking,if=!variable.align_3minutes|buff.bs_inc.up" );
cooldown->add_action( "potion,if=buff.bs_inc.up|fight_remains<32|(fight_remains<cooldown.bs_inc.remains&variable.lastConvoke&cooldown.convoke_the_spirits.remains<10)" );
cooldown->add_action( "prowl,if=buff.tigers_fury.up&combo_points<4&buff.sudden_ambush.down&dot.rake.pmultiplier<1.6&energy>35&target.time_to_die>5","TODO: fix prowl/meld to cast when rake conditions are met and invis would upgrade the snapshot" );
cooldown->add_action( "shadowmeld,if=buff.tigers_fury.up&combo_points<4&buff.sudden_ambush.down&dot.rake.pmultiplier<1.6&energy>35&target.time_to_die>5" );
cooldown->add_action( "convoke_the_spirits,if=fight_remains<5|(dot.rip.remains>5&buff.tigers_fury.up&(combo_points<2|(buff.bs_inc.up&combo_points=2))&(!variable.lastConvoke|!variable.lastZerk|buff.bs_inc.up))" );
cooldown->add_action( "use_item,name=manic_grieftorch,target_if=max:target.time_to_die,if=energy.deficit>40" );
cooldown->add_action( "use_items" );
