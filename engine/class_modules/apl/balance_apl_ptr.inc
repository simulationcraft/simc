action_priority_list_t* precombat = get_action_priority_list( "precombat" );
action_priority_list_t* def = get_action_priority_list( "default" );
action_priority_list_t* st = get_action_priority_list( "st" );
action_priority_list_t* aoe = get_action_priority_list( "aoe" );
action_priority_list_t* pre_cd = get_action_priority_list( "pre_cd" );

precombat->add_action( "variable,name=no_cd_talent,value=!talent.celestial_alignment&!talent.incarnation_chosen_of_elune|druid.no_cds","Snapshot raid buffed stats before combat begins and pre-potting is done." );
precombat->add_action( "variable,name=on_use_trinket,value=0" );
precombat->add_action( "variable,name=on_use_trinket,op=add,value=trinket.1.has_use_buff&!trinket.1.is.ovinaxs_mercurial_egg" );
precombat->add_action( "variable,name=on_use_trinket,op=add,value=(trinket.2.has_use_buff&!trinket.2.is.ovinaxs_mercurial_egg)*2" );
precombat->add_action( "moonkin_form" );
precombat->add_action( "wrath" );
precombat->add_action( "wrath" );
precombat->add_action( "wait,sec=0.1,if=hero_tree.keeper_of_the_grove&!talent.stellar_flare" );
precombat->add_action( "starfire,if=!talent.stellar_flare&hero_tree.elunes_chosen" );
precombat->add_action( "stellar_flare" );

def->add_action( "variable,name=passive_asp,value=6%spell_haste+talent.natures_balance+talent.orbit_breaker*dot.moonfire.ticking*(buff.orbit_breaker.stack>(27-2*buff.solstice.up))*24" );
def->add_action( "variable,name=ca_effective_cd,value=cooldown.ca_inc.remains<?cooldown.force_of_nature.remains" );
def->add_action( "variable,name=last_ca_inc,value=fight_remains<cooldown.ca_inc.duration+variable.ca_effective_cd" );
def->add_action( "variable,name=cd_condition,value=(fight_remains<(15+5*talent.incarnation_chosen_of_elune)*(1-talent.whirling_stars*0.2)|target.time_to_die>10&(!hero_tree.keeper_of_the_grove|(buff.harmony_of_the_grove.up|cooldown.force_of_nature.remains>25))&(!talent.whirling_stars|!talent.convoke_the_spirits|cooldown.convoke_the_spirits.remains<3|cooldown.convoke_the_spirits.remains>cooldown.ca_inc.full_recharge_time))&cooldown.ca_inc.ready&!buff.ca_inc.up" );
def->add_action( "use_item,name=aberrant_spellforge" );
def->add_action( "do_treacherous_transmitter_task,if=cooldown.ca_inc.remains>10" );
def->add_action( "use_item,name=spymasters_web,if=fight_remains<20" );
def->add_action( "use_item,name=imperfect_ascendancy_serum,if=dot.sunfire.remains>4&(dot.moonfire.remains>4|talent.treants_of_the_moon&(cooldown.force_of_nature.remains<3|buff.harmony_of_the_grove.up)&variable.ca_effective_cd<1|fight_remains<20|fight_remains<variable.ca_effective_cd&(buff.harmony_of_the_grove.up|cooldown.convoke_the_spirits.ready))&buff.spymasters_report.stack<=29" );
def->add_action( "use_item,name=treacherous_transmitter,if=(variable.ca_effective_cd<3|fight_remains<20|fight_remains<variable.ca_effective_cd&(buff.harmony_of_the_grove.up|cooldown.convoke_the_spirits.ready))&buff.spymasters_report.stack<=29" );
def->add_action( "variable,name=generic_trinket_condition,value=variable.no_cd_talent|fight_remains<variable.ca_effective_cd&(buff.harmony_of_the_grove.up|cooldown.convoke_the_spirits.ready)|((buff.spymasters_report.stack+variable.ca_effective_cd%6)>29|fight_remains<cooldown.ca_inc.duration+variable.ca_effective_cd)&variable.ca_effective_cd>20|variable.on_use_trinket=0" );
def->add_action( "use_item,slot=trinket1,if=!trinket.1.is.spymasters_web&!trinket.1.is.imperfect_ascendancy_serum&!trinket.1.is.treacherous_transmitter&(variable.on_use_trinket!=1&trinket.2.cooldown.remains>20|fight_remains<(20+20*(trinket.2.cooldown.remains<25))|variable.generic_trinket_condition)" );
def->add_action( "use_item,slot=trinket2,if=!trinket.2.is.spymasters_web&!trinket.2.is.imperfect_ascendancy_serum&!trinket.2.is.treacherous_transmitter&(variable.on_use_trinket!=2&trinket.1.cooldown.remains>20|fight_remains<(20+20*(trinket.1.cooldown.remains<25))|variable.generic_trinket_condition)" );
def->add_action( "use_items" );
def->add_action( "potion,if=fight_remains<=30" );
def->add_action( "berserking,if=variable.no_cd_talent|fight_remains<15" );
def->add_action( "variable,name=eclipse,value=buff.eclipse_lunar.up|buff.eclipse_solar.up" );
def->add_action( "variable,name=eclipse_remains,value=buff.eclipse_lunar.remains<?buff.eclipse_solar.remains" );
def->add_action( "variable,name=enter_lunar,value=talent.lunar_calling|spell_targets.starfire>2-(talent.umbral_intensity.rank+talent.soul_of_the_forest>1)" );
def->add_action( "variable,name=boat_stacks,value=buff.balance_of_all_things_arcane.stack+buff.balance_of_all_things_nature.stack" );
def->add_action( "warrior_of_elune,if=talent.lunar_calling|!talent.lunar_calling&variable.eclipse_remains>=7&cooldown.ca_inc.remains>20" );
def->add_action( "run_action_list,name=aoe,if=spell_targets>1" );
def->add_action( "run_action_list,name=st" );

st->add_action( "wrath,if=variable.enter_lunar&variable.eclipse&variable.eclipse_remains<cast_time" );
st->add_action( "starfire,if=!variable.enter_lunar&variable.eclipse&variable.eclipse_remains<cast_time" );
st->add_action( "sunfire,target_if=remains<3" );
st->add_action( "moonfire,target_if=remains<3&(!talent.treants_of_the_moon|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up)" );
st->add_action( "wrath,if=variable.enter_lunar&(!variable.eclipse|variable.eclipse_remains<cast_time)" );
st->add_action( "starfire,if=!variable.enter_lunar&(!variable.eclipse|variable.eclipse_remains<cast_time)" );
st->add_action( "call_action_list,name=pre_cd" );
st->add_action( "celestial_alignment,if=variable.cd_condition" );
st->add_action( "incarnation,if=variable.cd_condition" );
st->add_action( "force_of_nature,if=cooldown.ca_inc.remains<gcd.max&(!variable.eclipse|variable.eclipse_remains>6)|variable.eclipse_remains>=3&(cooldown.ca_inc.remains>10+15*talent.control_of_the_dream&(fight_remains>cooldown+5|cooldown.ca_inc.remains>fight_remains)|talent.whirling_stars&talent.convoke_the_spirits&cooldown.convoke_the_spirits.remains>cooldown.force_of_nature.duration-10)" );
st->add_action( "fury_of_elune,if=5+variable.passive_asp<astral_power.deficit" );
st->add_action( "starfall,if=buff.starweavers_warp.up" );
st->add_action( "starsurge,if=talent.starlord&buff.starlord.stack<3" );
st->add_action( "sunfire,target_if=refreshable" );
st->add_action( "moonfire,target_if=refreshable&(!talent.treants_of_the_moon|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up)" );
st->add_action( "stellar_flare,target_if=refreshable&(target.time_to_die-remains-target>7+spell_targets)" );
st->add_action( "variable,name=convoke_condition,value=fight_remains<5|(buff.ca_inc.up|cooldown.ca_inc.remains>40)&(!hero_tree.keeper_of_the_grove|buff.harmony_of_the_grove.up|cooldown.force_of_nature.remains>15)" );
st->add_action( "starsurge,if=cooldown.convoke_the_spirits.remains<gcd.max*2&variable.convoke_condition" );
st->add_action( "convoke_the_spirits,if=variable.convoke_condition" );
st->add_action( "starsurge,if=buff.starlord.remains>4&variable.boat_stacks>=3|fight_remains<4" );
st->add_action( "new_moon,if=astral_power.deficit>variable.passive_asp+energize_amount|fight_remains<20|cooldown.ca_inc.remains>15" );
st->add_action( "half_moon,if=astral_power.deficit>variable.passive_asp+energize_amount&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)|fight_remains<20|cooldown.ca_inc.remains>15" );
st->add_action( "full_moon,if=astral_power.deficit>variable.passive_asp+energize_amount&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)|fight_remains<20|cooldown.ca_inc.remains>15" );
st->add_action( "starsurge,if=buff.starweavers_weft.up|buff.touch_the_cosmos.up" );
st->add_action( "starsurge,if=astral_power.deficit<variable.passive_asp+action.wrath.energize_amount+(action.starfire.energize_amount+variable.passive_asp)*(buff.eclipse_solar.remains<(gcd.max*3))" );
st->add_action( "force_of_nature,if=!hero_tree.keeper_of_the_grove" );
st->add_action( "wild_mushroom" );
st->add_action( "starfire,if=talent.lunar_calling" );
st->add_action( "wrath" );

aoe->add_action( "wrath,if=variable.enter_lunar&variable.eclipse&variable.eclipse_remains<cast_time" );
aoe->add_action( "starfire,if=!variable.enter_lunar&variable.eclipse&variable.eclipse_remains<cast_time" );
aoe->add_action( "starfall,if=astral_power.deficit<=variable.passive_asp+6" );
aoe->add_action( "moonfire,target_if=refreshable&(target.time_to_die-remains)>6&(!talent.treants_of_the_moon|spell_targets-active_dot.moonfire_dmg>6|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up),if=fight_style.dungeonroute|fight_style.dungeonslice" );
aoe->add_action( "sunfire,target_if=refreshable&(target.time_to_die-remains)>6-(spell_targets%2)" );
aoe->add_action( "moonfire,target_if=refreshable&(target.time_to_die-remains)>6&(!talent.treants_of_the_moon|spell_targets-active_dot.moonfire_dmg>6|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up),if=!fight_style.dungeonroute&!fight_style.dungeonslice" );
aoe->add_action( "wrath,if=variable.enter_lunar&(!variable.eclipse|variable.eclipse_remains<cast_time)" );
aoe->add_action( "starfire,if=!variable.enter_lunar&(!variable.eclipse|variable.eclipse_remains<cast_time)" );
aoe->add_action( "stellar_flare,target_if=refreshable&(target.time_to_die-remains-target>7+spell_targets),if=spell_targets<(11-talent.umbral_intensity.rank-(2*talent.astral_smolder)-talent.lunar_calling)" );
aoe->add_action( "force_of_nature,if=cooldown.ca_inc.remains<gcd.max&(!variable.eclipse|variable.eclipse_remains>6)|variable.eclipse_remains>=3&cooldown.ca_inc.remains>10+15*talent.control_of_the_dream&(fight_remains>cooldown+5|cooldown.ca_inc.remains>fight_remains)" );
aoe->add_action( "fury_of_elune,if=variable.eclipse" );
aoe->add_action( "call_action_list,name=pre_cd" );
aoe->add_action( "celestial_alignment,if=variable.cd_condition" );
aoe->add_action( "incarnation,if=variable.cd_condition" );
aoe->add_action( "warrior_of_elune,if=!talent.lunar_calling&buff.eclipse_solar.remains<7|talent.lunar_calling" );
aoe->add_action( "starfire,if=(!talent.lunar_calling&spell_targets.starfire=1)&(buff.eclipse_solar.up&buff.eclipse_solar.remains<action.starfire.cast_time|eclipse.in_none)" );
aoe->add_action( "starfall,if=buff.starweavers_warp.up|buff.touch_the_cosmos.up" );
aoe->add_action( "starfall" );
aoe->add_action( "convoke_the_spirits,if=(!buff.dreamstate.up&!buff.umbral_embrace.up&spell_targets.starfire<7|spell_targets.starfire=1)&(fight_remains<5|(buff.ca_inc.up|cooldown.ca_inc.remains>40)&(!hero_tree.keeper_of_the_grove|buff.harmony_of_the_grove.up|cooldown.force_of_nature.remains>15))" );
aoe->add_action( "new_moon" );
aoe->add_action( "half_moon" );
aoe->add_action( "full_moon" );
aoe->add_action( "wild_mushroom" );
aoe->add_action( "force_of_nature,if=!hero_tree.keeper_of_the_grove" );
aoe->add_action( "starfire,if=talent.lunar_calling|buff.eclipse_lunar.up&spell_targets.starfire>1" );
aoe->add_action( "wrath" );

pre_cd->add_action( "use_item,name=spymasters_web,if=variable.cd_condition&(buff.spymasters_report.stack>29|fight_remains<cooldown.ca_inc.duration)" );
pre_cd->add_action( "do_treacherous_transmitter_task,if=variable.cd_condition" );
pre_cd->add_action( "berserking,if=variable.cd_condition" );
pre_cd->add_action( "potion,if=variable.cd_condition" );
pre_cd->add_action( "use_item,slot=trinket1,if=!trinket.1.is.spymasters_web&!trinket.1.is.imperfect_ascendancy_serum&!trinket.1.is.treacherous_transmitter&(variable.on_use_trinket=1|variable.on_use_trinket=3)&variable.cd_condition" );
pre_cd->add_action( "use_item,slot=trinket2,if=!trinket.2.is.spymasters_web&!trinket.2.is.imperfect_ascendancy_serum&!trinket.2.is.treacherous_transmitter&variable.on_use_trinket=2&variable.cd_condition" );
