action_priority_list_t* precombat = get_action_priority_list( "precombat" );
action_priority_list_t* def = get_action_priority_list( "default" );
action_priority_list_t* st = get_action_priority_list( "st" );
action_priority_list_t* aoe = get_action_priority_list( "aoe" );
action_priority_list_t* fallthru = get_action_priority_list( "fallthru" );

precombat->add_action( "variable,name=no_cd_talent,value=!talent.celestial_alignment&!talent.incarnation_chosen_of_elune|druid.no_cds" );
precombat->add_action( "variable,name=on_use_trinket,value=0" );
precombat->add_action( "variable,name=on_use_trinket,op=add,value=trinket.1.has_proc.any&trinket.1.cooldown.duration|trinket.1.is.spoils_of_neltharus" );
precombat->add_action( "variable,name=on_use_trinket,op=add,value=(trinket.2.has_proc.any&trinket.2.cooldown.duration|trinket.2.is.spoils_of_neltharus)*2" );
precombat->add_action( "moonkin_form" );
precombat->add_action( "wrath" );
precombat->add_action( "wrath" );
precombat->add_action( "stellar_flare" );
precombat->add_action( "starfire,if=!talent.stellar_flare" );

def->add_action( "variable,name=is_aoe,value=spell_targets.starfall>(1+(!talent.aetherial_kindling&!talent.starweaver))&talent.starfall" );
def->add_action( "variable,name=passive_asp,value=6%spell_haste+talent.natures_balance+talent.orbit_breaker*dot.moonfire.ticking*(buff.orbit_breaker.stack>(27-2*buff.solstice.up))*40" );
def->add_action( "berserking,if=buff.ca_inc.remains>=20|variable.no_cd_talent|fight_remains<15" );
def->add_action( "potion,if=!druid.no_cds&(buff.ca_inc.remains>=20|variable.no_cd_talent|fight_remains<30)" );
def->add_action( "use_items,slots=trinket1,if=variable.on_use_trinket!=1&!trinket.2.ready_cooldown|(variable.on_use_trinket=1|variable.on_use_trinket=3)&buff.ca_inc.up|variable.no_cd_talent|fight_remains<20|variable.on_use_trinket=0" );
def->add_action( "use_items,slots=trinket2,if=variable.on_use_trinket!=2&!trinket.1.ready_cooldown|variable.on_use_trinket=2&buff.ca_inc.up|variable.no_cd_talent|fight_remains<20|variable.on_use_trinket=0" );
def->add_action( "use_items" );
def->add_action( "natures_vigil" );
def->add_action( "invoke_external_buff,name=power_infusion" );
def->add_action( "run_action_list,name=aoe,if=variable.is_aoe" );
def->add_action( "run_action_list,name=st" );

st->add_action( "sunfire,target_if=refreshable&remains<2&(target.time_to_die-remains)>6" );
st->add_action( "moonfire,target_if=refreshable&remains<2&(target.time_to_die-remains)>6" );
st->add_action( "stellar_flare,target_if=refreshable&astral_power.deficit>variable.passive_asp+8&remains<2&(target.time_to_die-remains)>8" );
st->add_action( "variable,name=cd_condition_st,value=!druid.no_cds&(cooldown.ca_inc.remains<15&!buff.ca_inc.up&(target.time_to_die>15|fight_remains<25+10*talent.incarnation_chosen_of_elune))" );
st->add_action( "cancel_buff,name=starlord,if=buff.starlord.remains<2&(buff.primordial_arcanic_pulsar.value>=550&!buff.ca_inc.up&buff.starweavers_warp.up|buff.primordial_arcanic_pulsar.value>=560&buff.starweavers_weft.up)" );
st->add_action( "starfall,if=buff.primordial_arcanic_pulsar.value>=550&!buff.ca_inc.up&buff.starweavers_warp.up" );
st->add_action( "starsurge,if=buff.primordial_arcanic_pulsar.value>=560&buff.starweavers_weft.up" );
st->add_action( "celestial_alignment,if=variable.cd_condition_st" );
st->add_action( "incarnation,if=variable.cd_condition_st" );
st->add_action( "warrior_of_elune" );
st->add_action( "variable,name=solar_eclipse_st,value=buff.primordial_arcanic_pulsar.value<520&cooldown.ca_inc.remains>5&spell_targets.starfire<3" );
st->add_action( "variable,name=enter_eclipse,value=eclipse.any_next|variable.solar_eclipse_st&buff.eclipse_solar.up&(buff.eclipse_solar.remains<action.starfire.cast_time)|!variable.solar_eclipse_st&buff.eclipse_lunar.up&(buff.eclipse_lunar.remains<action.wrath.cast_time)" );
st->add_action( "starfire,if=variable.enter_eclipse&variable.solar_eclipse_st" );
st->add_action( "wrath,if=variable.enter_eclipse" );
st->add_action( "variable,name=convoke_condition,value=buff.ca_inc.remains>4|(cooldown.ca_inc.remains>30|variable.no_cd_talent)&(buff.eclipse_lunar.remains>4|buff.eclipse_solar.remains>4)" );
st->add_action( "starsurge,if=talent.convoke_the_spirits&cooldown.convoke_the_spirits.ready&variable.convoke_condition" );
st->add_action( "convoke_the_spirits,if=variable.convoke_condition" );
st->add_action( "astral_communion,if=astral_power.deficit>variable.passive_asp+55" );
st->add_action( "force_of_nature,if=astral_power.deficit>variable.passive_asp+20" );
st->add_action( "fury_of_elune,if=target.time_to_die>2&(buff.ca_inc.remains>3|cooldown.ca_inc.remains>30&buff.primordial_arcanic_pulsar.value<=280|buff.primordial_arcanic_pulsar.value>=560&astral_power>50)|fight_remains<10" );
st->add_action( "starfall,if=buff.starweavers_warp.up" );
st->add_action( "variable,name=starsurge_condition1,value=talent.starlord&buff.starlord.stack<3|talent.rattle_the_stars&buff.rattled_stars.up&buff.rattled_stars.remains<gcd.max" );
st->add_action( "cancel_buff,name=starlord,if=buff.starlord.remains<2&variable.starsurge_condition1" );
st->add_action( "starsurge,if=variable.starsurge_condition1" );
st->add_action( "sunfire,target_if=refreshable&astral_power.deficit>variable.passive_asp+3" );
st->add_action( "moonfire,target_if=refreshable&astral_power.deficit>variable.passive_asp+3" );
st->add_action( "stellar_flare,target_if=refreshable&astral_power.deficit>variable.passive_asp+8" );
st->add_action( "new_moon,if=astral_power.deficit>variable.passive_asp+10" );
st->add_action( "half_moon,if=astral_power.deficit>variable.passive_asp+20&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)&(buff.ca_inc.up|charges_fractional>2.5&buff.primordial_arcanic_pulsar.value<=520&buff.ca_inc.remains>10|fight_remains<10)" );
st->add_action( "full_moon,if=astral_power.deficit>variable.passive_asp+40&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)&(buff.ca_inc.up|charges_fractional>2.5&buff.primordial_arcanic_pulsar.value<=520&buff.ca_inc.remains>10|fight_remains<10)" );
st->add_action( "variable,name=starsurge_condition2,value=buff.starweavers_weft.up|astral_power.deficit<variable.passive_asp+action.wrath.energize_amount+(action.starfire.energize_amount+variable.passive_asp)*(buff.eclipse_solar.remains<(gcd.max*3))|talent.astral_communion&cooldown.astral_communion.remains<3|fight_remains<5" );
st->add_action( "cancel_buff,name=starlord,if=buff.starlord.remains<2&variable.starsurge_condition2" );
st->add_action( "starsurge,if=variable.starsurge_condition2" );
st->add_action( "wild_mushroom,if=talent.fungal_growth&(!fight_style.dungeonroute|target.time_to_die>(full_recharge_time-7)|fight_remains<10)" );
st->add_action( "starfire,if=buff.ca_inc.up&buff.warrior_of_elune.up&buff.warrior_of_elune.stack=1" );
st->add_action( "wrath" );
st->add_action( "run_action_list,name=fallthru" );

aoe->add_action( "moonfire,target_if=refreshable&(target.time_to_die-remains)>6&astral_power.deficit>variable.passive_asp+3,if=fight_style.dungeonroute" );
aoe->add_action( "sunfire,target_if=refreshable&(target.time_to_die-remains)>6-(spell_targets%2)&astral_power.deficit>variable.passive_asp+3" );
aoe->add_action( "moonfire,target_if=refreshable&(target.time_to_die-remains)>6&astral_power.deficit>variable.passive_asp+3,if=!fight_style.dungeonroute" );
aoe->add_action( "variable,name=cd_condition_aoe,value=!druid.no_cds&(cooldown.ca_inc.remains<5&!buff.ca_inc.up&(target.time_to_die>10|fight_remains<25+10*talent.incarnation_chosen_of_elune))" );
aoe->add_action( "stellar_flare,target_if=refreshable&(target.time_to_die-remains-spell_targets.starfire)>8+spell_targets.starfire,if=astral_power.deficit>variable.passive_asp+8&spell_targets.starfire<(11-talent.umbral_intensity.rank-talent.astral_smolder.rank)&variable.cd_condition_aoe" );
aoe->add_action( "variable,name=starfall_condition1,value=variable.cd_condition_aoe&(talent.orbital_strike&astral_power.deficit<variable.passive_asp+8*spell_targets|buff.touch_the_cosmos.up)|astral_power.deficit<(variable.passive_asp+8+12*(buff.eclipse_lunar.remains<4|buff.eclipse_solar.remains<4))" );
aoe->add_action( "cancel_buff,name=starlord,if=buff.starlord.remains<2&variable.starfall_condition1" );
aoe->add_action( "starfall,if=variable.starfall_condition1" );
aoe->add_action( "celestial_alignment,if=variable.cd_condition_aoe" );
aoe->add_action( "incarnation,if=variable.cd_condition_aoe" );
aoe->add_action( "warrior_of_elune" );
aoe->add_action( "variable,name=enter_solar,value=spell_targets.starfire<3" );
aoe->add_action( "starfire,if=variable.enter_solar&(eclipse.any_next|buff.eclipse_solar.remains<action.starfire.cast_time)" );
aoe->add_action( "wrath,if=!variable.enter_solar&(eclipse.any_next|buff.eclipse_lunar.remains<action.wrath.cast_time)" );
aoe->add_action( "wild_mushroom,if=astral_power.deficit>variable.passive_asp+20&(!talent.fungal_growth|!talent.waning_twilight|dot.fungal_growth.remains<2&target.time_to_die>7&!prev_gcd.1.wild_mushroom)" );
aoe->add_action( "fury_of_elune,if=target.time_to_die>2&(buff.ca_inc.remains>3|cooldown.ca_inc.remains>30&buff.primordial_arcanic_pulsar.value<=280|buff.primordial_arcanic_pulsar.value>=560&astral_power>50)|fight_remains<10" );
aoe->add_action( "variable,name=starfall_condition2,value=target.time_to_die>4&(buff.starweavers_warp.up|talent.starlord&buff.starlord.stack<3)" );
aoe->add_action( "cancel_buff,name=starlord,if=buff.starlord.remains<2&variable.starfall_condition2" );
aoe->add_action( "starfall,if=variable.starfall_condition2" );
aoe->add_action( "full_moon,if=astral_power.deficit>variable.passive_asp+40&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)&(buff.ca_inc.up|charges_fractional>2.5&buff.primordial_arcanic_pulsar.value<=520&buff.ca_inc.remains>10|fight_remains<10)" );
aoe->add_action( "starsurge,if=buff.starweavers_weft.up&spell_targets.starfire<3" );
aoe->add_action( "stellar_flare,target_if=refreshable&(target.time_to_die-remains-spell_targets.starfire)>8+spell_targets.starfire,if=astral_power.deficit>variable.passive_asp+8&spell_targets.starfire<(11-talent.umbral_intensity.rank-talent.astral_smolder.rank)" );
aoe->add_action( "astral_communion,if=astral_power.deficit>variable.passive_asp+50" );
aoe->add_action( "convoke_the_spirits,if=astral_power<50&spell_targets.starfall<3+talent.elunes_guidance&(buff.eclipse_lunar.remains>4|buff.eclipse_solar.remains>4)" );
aoe->add_action( "new_moon,if=astral_power.deficit>variable.passive_asp+10" );
aoe->add_action( "half_moon,if=astral_power.deficit>variable.passive_asp+20&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)" );
aoe->add_action( "force_of_nature,if=astral_power.deficit>variable.passive_asp+20" );
aoe->add_action( "starsurge,if=buff.starweavers_weft.up&spell_targets.starfire<17" );
aoe->add_action( "starfire,if=spell_targets>3&buff.eclipse_lunar.up|eclipse.in_lunar" );
aoe->add_action( "wrath" );
aoe->add_action( "run_action_list,name=fallthru" );

fallthru->add_action( "starfall,if=variable.is_aoe" );
fallthru->add_action( "starsurge" );
fallthru->add_action( "sunfire,target_if=dot.moonfire.remains>remains*22%18" );
fallthru->add_action( "moonfire" );
